---
title: "West Nile Virus Prediction in Chicago"
author: "gbartusk"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```


```{r research_notes}

# - 33 mosquitos facts: ://www.megacatch.com/mosquitofacts.html
#   > They are cold-blooded and prefer temperatures over 80 degrees. At temperatures less than 50 degrees, they shut down for the winter
#   > Mosquitoes spend their first 10 days in water
#   > Usually, the eggs are deposited in clusters - called rafts - on the surface of stagnant water, or they are laid in areas that flood regularly.
#   > The average mosquito lifespan is less than two months. Males have the shortest lives, usually 10 days or less, and females can live about six to eight weeks, under ideal conditions
#   > Mosquitoes cant fly very far or very fast. Most mosquitoes can fly no more than about one to three miles, and often stay within several hundred feet of where they were hatched
#   > Body heat marks the target. Mosquitoes use heat sensors around their mouthparts to detect the warmth of your body
#   > West Nile virus came to the U.S. in 1999 with an epidemic in New York
#

# - CDC: http://www.cdc.gov/westnile/faq/genQuestions.html
#   > The weather, numbers of birds that maintain the virus, numbers of mosquitoes that spread the virus, and human behavior are all factors that can influence when and where outbreaks occur
#

# - chicago grid: http://www.domu.com/blog/decoding-the-chicago-street-grid-system

# - research paper on WNV (seen commented on kaggle script)
# - http://www.ajtmh.org/content/80/2/268.full


```


```{r load_pkgs_udfs}
# - load packages
library(knitr)          # - report writing
library(ggplot2)        # - plotting
library(gridExtra)      # - panel plots
library(dplyr)          # - data manipulation
library(lubridate)      # - date functions
library(Metrics)        # - supervised learning evaluation metrics
library(ggmap)          # - maps
library(Hmisc)          # - 
library(MASS)           # - applied stats methods
library(class)          # - functions for classification
library(caret)          # - model training functions
library(pryr)           # - check memory
library(rpart)          # - regression trees
library(rattle)         # - regression tree plots
library(gbm)            # - boosting with trees
library(gam)            # - generalized additive models

# - directory paths
dir_root <- file.path("/Users/Gus/Google Drive/dev/kaggle/west_nile_chicago/")
dir_data <- file.path(dir_root, "data")
dir_submissions <- file.path(dir_root, "submissions")

# - file paths
path_src_toolbox <- file.path(dir_root,"toolbox.R")
path_data_spray <- file.path(dir_data, "spray.csv.zip")
path_data_weather <- file.path(dir_data, "weather.csv.zip")
path_data_train <- file.path(dir_data, "train.csv.zip")
path_data_test <- file.path(dir_data, "test.csv.zip")
path_data_submission <- file.path(dir_data, "sampleSubmission.csv.zip")
path_map_chicago <- file.path(dir_data, "mapdata_copyright_openstreetmap_contributors.rds")
path_map_chicago_txt <- file.path(dir_data, "mapdata_copyright_openstreetmap_contributors.txt.zip")

# - load R src files
source(path_src_toolbox)    # - udfs

```


```{r load_data}
# - load: spray data
df_spray <- load_spray(path_data_spray)

# - load: weather data
df_weather <- load_weather(path_data_weather, impute=TRUE)

# - load: training data
df_train <- load_train(path_data_train, collapse=TRUE)

# - load: test data
#   there is ALOT of data here, due to simulated traps???
df_test <- load_test(path_data_test)

# - load: sample submission
df_submission <- load_submission(path_data_submission)

# - join: train and weather
df_train_wthr <- join_train_weather()

# - join: train and weather
df_test_wthr <- join_test_weather()


```


```{r data_wrangle}
# - Summary:
#   

# - wnv only data
df_train_wnv <- dplyr::filter(df_train, WnvPresentF=="present")
df_train_wthr_wnv <- dplyr::filter(df_train_wthr, WnvPresentF=="present")



# - pca: compute
df_train_wthr_pca <- df_train_wthr %>% dplyr::select(Tmax,Tmin,Tavg,DewPoint,WetBulb,Heat,Cool,PrecipTotal,StnPressure,SeaLevel,ResultSpeed,ResultDir,AvgSpeed,Latitude,Longitude,Elevation)
df_test_wthr_pca <- df_test_wthr %>% dplyr::select(Tmax,Tmin,Tavg,DewPoint,WetBulb,Heat,Cool,PrecipTotal,StnPressure,SeaLevel,ResultSpeed,ResultDir,AvgSpeed,Latitude,Longitude,Elevation)
# - look at correlation table
M <- abs(cor(df_train_wthr_pca))   # - how to deal with NA??
diag(M) <- 0
which(M > 0.7, arr.ind = T)
View(M)
# - have to use same PCs that calc'd on training for test (ie the rotations)
fit_weather_pca <- caret::preProcess(df_train_wthr_pca, method="pca", thresh=0.9)
pred_weather_train_pca <- predict(fit_weather_pca, df_train_wthr_pca)
pred_weather_test_pca <- predict(fit_weather_pca, df_test_wthr_pca)

df_train_wthr <- cbind(df_train_wthr,pred_weather_train_pca)

# - join: spray data
#   > the spray times are all atleast 1wk apt (only 10 total times)
unique(df_spray$Date)
#   > first we need to know the most recent spray time
#     ie max(spray date <= train date)
#   > from that set (ie last spray date) we need to know closest spraying
#     to that location
#   > then we need to pick a threshold on both day since last spray and 
#     distance of spray from location
#       > The average mosquito lifespan is less than two months 
#         avg - males: <10d, females: 6-8wks
#       > Most mosquitoes can fly no more than about one to three miles, and 
#         often stay within several hundred feet of where they were hatched

```


```{r data_stats}
# - Summary
#   > only 5% of the data is WNV (of 10.5k records)
#   > 4/7 species have no wnv, doesnt seem like a good feature?
#   > the training set has years 07,09,11,13 (train had even years)
#   > year has many wnv cases in 2007 and 2013 ... why??? year doesnt make
#     since as a feature but what even drives that barbell does! Perhaps
#     they sprayed alot more in those years??
#   > We know CDPH sets traps from late-may to early-october, August has
#     the most cases but this is most likely only because its hottest then?
#   > Day / WkDay probably are not important since CDPH lets the traps collect
#     mosquitos Mon-Wed and then tests by the end of the week
#   > spray data only has 10 dates and is not provided for the test set
#     there are alot of forum posts complaining about this
#   > training data has very few obs in May but test data has no May data
#   >
#   >

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - training data 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# - table: wnv
round(prop.table(table(df_train$WnvPresentF)),2)

# - table: wnv by species
#   WNV only shows up for three of the species
t_wnv_by_species <- table(df_train$Species, df_train$WnvPresentF)
t_wnv_by_species
round(prop.table(t_wnv_by_species)*100,2)

# - table: wnv by year
t_wnv_by_yr <- table(df_train$Year, df_train$WnvPresentF)
t_wnv_by_yr
round(prop.table(t_wnv_by_yr)*100,2)

# - table: wnv by month
t_wnv_by_mo <- table(df_train$Month, df_train$WnvPresentF)
t_wnv_by_mo
round(prop.table(t_wnv_by_mo)*100,2)

# - table wnv by day
t_wnv_by_day <- table(df_train$Day, df_train$WnvPresentF)
t_wnv_by_day
round(prop.table(t_wnv_by_day)*100,2)

# - table wnv by weekday day
t_wnv_by_wday <- table(df_train$WkDay, df_train$WnvPresentF)
t_wnv_by_wday
round(prop.table(t_wnv_by_wday)*100,2)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - spay dates
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

round(prop.table(table(year(df_spray$Date), month(df_spray$Date)))*100,2)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - weather data
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# - weather data only available for summer but covers all months
#   and years in train/test set
table(df_weather$Month, df_weather$Year)

# - wnv by temp and month
table(df_train_wthr$WnvPresentF, Hmisc::cut2(df_train_wthr$Tmax, g=5), df_train_wthr$Month)



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - clean up
rm(t_wnv_by_species, t_wnv_by_yr, t_wnv_by_mo, t_wnv_by_day, t_wnv_by_wday)



```


```{r data_vis}
# - Summary
#   > 

# - load: ggmap of chicago provided by kaggle
gmap_chicago <- readRDS(path_map_chicago)

# - bubble chart: suffer from overplotting, one solution is binning
ggmap(gmap_chicago) + 
    geom_point(data=df_train_wnv, 
        aes(x=Longitude, y=Latitude, colour=Species, size=Species))

# - boxed contour plot: location of WNV without knowing frequency
ggmap(gmap_chicago) + 
    stat_bin2d(
        data=df_train_wnv, 
        aes(x=Longitude, y=Latitude, colour=Species, fill=Species),
        size=0.5, bins=50, alpha=0.5)

# - create overlay
overlay <- stat_density2d(
    aes(x=Longitude, y=Latitude, fill = ..level.., alpha = ..level..),
    bins = 4, geom = "polygon", data = df_train_wnv)
# - map with overlay (need to fix two level keys)
ggmap(gmap_chicago) + overlay + inset(
    grob=ggplotGrob(ggplot() + overlay + theme_inset()),
    xmin=-Inf, xmax=-87.85, ymin=41.6, ymax=41.7)

# - filled contour plot
#   '.. ..' is used b/c aesthetic is not present in orig data, but rather is
#   calc'd by the contour statistic
ggmap(gmap_chicago) + 
    stat_density2d(data=df_train_wnv, 
        aes(x=Longitude, y=Latitude, fill=..level.., alpha=..level..),
        bins=5, geom="polygon") +
    scale_fill_gradient(low="black", high="red") +
    facet_wrap(~Year)

# - pull ggmap of chicago (need to fix two level keys)
ll <- ggmap::geocode("chicago", messaging=F)
g_roadmap <- get_map(location=c(lon=ll[["lon"]],lat=ll[["lat"]]), source="google", 
    maptype="roadmap", crop=FALSE)

# - plot: trap locations
dplyr::n_distinct(df_train$Trap)
ggmap(g_roadmap) + 
    geom_point(data=df_train, aes(x=Longitude, y=Latitude)) +
    labs(x="Longitude", y="Latitude", title="Trap Locations")

# - plot spray data
ggmap(g_roadmap) + 
    geom_point(data=df_spray, aes(x=Longitude, y=Latitude)) +
    facet_grid(.~Date) +
    labs(x="Longitude", y="Latitude", title="Spray Locations by Year")

# - plot: wnv across years
ggmap(g_roadmap) +
    geom_point(data=df_train, aes(x=Longitude, y=Latitude, 
        colour=WnvPresentF, size=NumMosquitos), alpha=0.2) +
    facet_grid(WnvPresentF~Year) +
    scale_colour_manual(values=c("forestgreen","red")) +
    labs(x="Longitude", y="Latitude", title="WNV By Year")

# - plot: wnv present across years and type 
#   the cases seem to be mostly localized in north and south of the city, most
#   likely because there is alot more greenland there than in city centre.
#   Mosquitos become infected when they feed on infected birds
ggmap(g_roadmap) +
    geom_point(data=df_train_wnv, 
        aes(x=Longitude, y=Latitude, size=NumMosquitos), alpha=0.2) +
    facet_grid(Species~Year) +
    labs(x="Longitude", y="Latitude", title="WNV by Year and Species")

# - plot: wnv across months
#   august appears very significant (compared to july and september), most
#   likely because thats when its the hotest?
ggmap(g_roadmap) +
    geom_point(data=df_train, aes(x=Longitude, y=Latitude, 
        colour=WnvPresentF, size=NumMosquitos), alpha=0.2) +
    facet_grid(WnvPresentF~Month) +
    scale_colour_manual(values=c("forestgreen","red")) +
    labs(x="Longitude", y="Latitude", title="WNV by Month")


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - TRAINING
ggplot(data=df_train_wthr, aes(x=Species)) + geom_histogram() + facet_grid(.~WnvPresentF)
ggplot(data=df_train_wthr, aes(x=Year)) + geom_histogram() + facet_grid(.~WnvPresentF)
ggplot(data=df_train_wthr, aes(x=Month)) + geom_histogram() + facet_grid(.~WnvPresentF)
ggplot(data=df_train_wthr, aes(x=Day)) + geom_histogram() + facet_grid(.~WnvPresentF)



#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - WEATHER

# - wnv by min temp
g_Tmin <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=Tmin, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by avg temp
g_Tavg <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=Tavg, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by max temp
g_Tmax <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=Tmax, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by departure (from normal temp?)
g_Depart <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=Depart, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by dew point (relative humidity)
g_DewPoint <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=DewPoint, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by wet bulb (similar to dew point)
g_WetBulb <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=WetBulb, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by heating
g_Heat <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=Heat, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by cooling
g_Cool <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=Cool, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by depth: no variability, same for both
g_Depth <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=Depth, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by snowfall: no variability, same for both
g_SnowFall <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=SnowFall, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by PrecipTotal: LOTS of outliers
g_PrecipTotal <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=PrecipTotal, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by StnPressure: some variability but same by wnv
g_StnPressure <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=StnPressure, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by SeaLevel: some variability but same by wnv
g_SeaLevel <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=SeaLevel, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by ResultSpeed (wind speed): more wnv at lower speed
g_ResultSpeed <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=ResultSpeed, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by ResultDir (wind direction): some variability but same by wnv
g_ResultDir <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=ResultDir, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by AvgSpeed (wind avg speed): more wnv at lower speed
g_AvgSpeed <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=AvgSpeed, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')
# - wnv by Elevation: more wnv at low or high elevation (see denisity plot)
g_Elevation <- ggplot(data=df_train_wthr, aes(x=WnvPresentF, y=Elevation, colour=WnvPresentF)) + geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=5, size=4) + stat_summary(fun.y=mean, geom="line", aes(group=1), colour="black") + theme(axis.title.x = element_blank(), legend.position='none')

cor(df_weather[,c("Tmin","Tavg","Tmax","Depart","DewPoint","WetBulb","Heat","Cool")])

# - plot grid
gridExtra::grid.arrange(g_Tmin, g_Tavg, g_Tmax, g_Depart, g_DewPoint, g_WetBulb, g_ResultSpeed, nrow=1)
gridExtra::grid.arrange(g_Tmin, g_Tavg, g_Tmax, g_Heat, g_Cool, nrow=1)

gridExtra::grid.arrange(g_StnPressure, g_SeaLevel, g_Depth, g_SnowFall, nrow=1)


ggplot(data=df_train_wthr, aes(x=DewPoint, colour=WnvPresentF)) + geom_density()
ggplot(data=df_train_wthr, aes(x=WetBulb, colour=WnvPresentF)) + geom_density()
ggplot(data=df_train_wthr, aes(x=Elevation, colour=WnvPresentF)) + geom_density()

ggplot(data=df_train_wthr, aes(x=PrecipTotal, colour=WnvPresentF)) + geom_density()

```


```{r model_logistic}
# - Summary:
#   > 

# - Notes:
#   > caret: http://topepo.github.io/caret/training.html#custom
#   > 
#   > 


# - set seed for reproducibility
set.seed(123)


# - create cross validation set within training set
train_index <- caret::createDataPartition(y=df_train_wthr$WnvPresent, p=0.8, list=FALSE, times=1)
df_train_fit <- df_train_wthr[train_index,]
df_train_val <-  df_train_wthr[-train_index,]
rm(train_index)
# - check proportions
prop.table(table(df_train_wthr$WnvPresentF))*100
prop.table(table(df_train_fit$WnvPresentF))*100
prop.table(table(df_train_val$WnvPresentF))*100


# - stepwise regression
df_train_fit_regs <- df_train_fit %>% dplyr::select(-WnvPresentF, -Address, -Street, -AddressNumberAndStreet, -AddressAccuracy, -DateStr, -WkDay, -Trap, -Date, -NumMosquitos)
# - na vaues will 
fit_all <- glm(WnvPresent ~ ., data=df_train_fit, family="binomial")
step <- stepAIC(fit_all, direction="both", trace=0)
step$anova
glmStepAIC
# - this take forever!
fit_logit_step <- caret::train(WnvPresent ~ ., data=df_train_fit_regs, method="glmStepAIC", family="binomial")


# - fit: logistic model
# - For example, in problems where there are a low percentage of samples in one class, using metric = "Kappa" can improve quality of the final model.
train_ctrl <- trainControl(method = "repeatedcv", number = 10, repeats=3)
fit_logit <- caret::train(WnvPresentF ~ Latitude + Longitude + Latitude*Longitude + Year + Month + Day + Tmax + I(Tmax^2) + PrecipTotal + I(PrecipTotal^2) + DewPoint + I(DewPoint^2) + Species + SeaLevel, data=df_train_fit, method="glm", family="binomial", trControl = train_ctrl)
# - print model
fit_logit
summary(fit_logit$finalModel)

# - roc / accuracy: train fit
pred_logit_train <- predict(fit_logit, newdata=df_train_fit, type="prob")[,"present"]
Metrics::auc(df_train_fit$WnvPresent, pred_logit_train)
caret::confusionMatrix(df_train_fit$WnvPresentF, predict(fit_logit, newdata=df_train_fit))

# - roc / accuracy: validation
pred_logit_val <- predict(fit_logit, newdata=df_train_val, type="prob")[,"present"]
Metrics::auc(df_train_val$WnvPresent, pred_logit_val)
caret::confusionMatrix(df_train_val$WnvPresentF, predict(fit_logit, newdata=df_train_val))

# - fit: refit the model on all data
fit_logit_all <- caret::train(WnvPresentF ~ Latitude + Longitude + Latitude*Longitude + Year + Month + Day + Tmax + I(Tmax^2) + PrecipTotal + I(ln(PrecipTotal)) + DewPoint + I(DewPoint^2) + Species + SeaLevel, data=df_train_wthr, method="glm", family="binomial", trControl=train_ctrl)

# - roc / accuracy: train all
pred_logit_all <- predict(fit_logit_all, newdata=df_train_wthr, type="prob")[,"present"]
Metrics::auc(df_train_wthr$WnvPresent, pred_logit_all)
caret::confusionMatrix(df_train_wthr$WnvPresentF, predict(fit_logit_all, newdata=df_train_wthr))

# - create submission file
df_submission <- load_submission(path_data_submission)
df_submission$WnvPresent <- predict(fit_logit_all, newdata=df_test_wthr, type="prob")[,"present"]
path_submit <- file.path(dir_submissions, "#_step_logistic_CV.csv")
readr::write_csv(df_submission, path_submit)


```


```{r model_lda}
# - linear discriminant analysis
fit_lda <- caret::train(WnvPresentF ~ Latitude + Longitude + Station + Block + Year + Month + Tavg + DewPoint + Species, data=df_train_wthr, method="lda")
# - area under roc curve
pred_lda_train <- predict(fit_lda, newdata=df_train_wthr, type="prob")[,"present"]
Metrics::auc(df_train_wthr$WnvPresent, pred_lda_train)
# - accuracy 
caret::confusionMatrix(df_train_wthr$WnvPresentF, predict(fit_lda, newdata=df_train_wthr))

```


```{r model_qda}

# - lda assumes that regressors are dist multi-var gaussian for each Y class
#   and that there is a single cor-matrix

```


```{r model_gam}
# - smoothing splines 


```


```{r model_knn}
# - K-Nearest Neighbors
#class:knn()
```


```{r model_trees}
# - trees, bagging, boosting, oh my
# - random forests are usually one of the two top performing algos along
#   with boosting in prediction contests

# - notes
#   > boosting tutorial: http://webee.technion.ac.il/people/rmeir/BoostingTutorial.pdf
#   >
#   >

# - check which colummsn are not in test data
colnames(df_train_wthr)[!(colnames(df_train_wthr) %in% colnames(df_test_wthr))]

df_train_fit_regs <- df_train_wthr %>% dplyr::select(-WnvPresent, -Depart, -Sunrise, -Sunset,-Depth, -Water1, -SnowFall, -Address, -Street, -AddressNumberAndStreet, -AddressAccuracy, -DateStr, -WkDay, -CodeSum, -Trap, -Date, -SatelliteTrap, -NumMosquitos)

colnames(df_train_fit_regs)[!(colnames(df_train_fit_regs) %in% colnames(df_test_wthr))]


# - create cross validation set within training set
train_index <- caret::createDataPartition(y=df_train_wthr$WnvPresent, p=0.8, list=FALSE, times=1)
df_train_fit <- df_train_wthr[train_index,]
df_train_val <-  df_train_wthr[-train_index,]
rm(train_index)
# - check proportions
prop.table(table(df_train_wthr$WnvPresentF))*100
prop.table(table(df_train_fit$WnvPresentF))*100
prop.table(table(df_train_val$WnvPresentF))*100
# - v
colnames(df_train_wthr)[!(colnames(df_train_wthr) %in% colnames(df_test_wthr))]



# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - TREES
# - fir regression tree ... only one break given so few wnv cases
fit <- train(WnvPresentF ~ ., method="rpart", data=df_train_fit_regs)
fit$finalModel
# - plot tree ... doesnt work with one break
rattle::fancyRpartPlot(fit$finalModel)


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - BOOSTING WITH TREES (submission 4,7)

# - fit:stochastic gradient boosting
fit_gbm <- train(WnvPresentF ~ Latitude + Longitude + Latitude*Longitude + Year + Month + Day + Tmax + I(Tmax^2) + PrecipTotal + I(PrecipTotal^2) + DewPoint + I(DewPoint^2) + Species + SeaLevel, data=df_train_fit, method="gbm", verbose=F)
fit_gbm
fit_gbm$finalModel

# - roc / accuracy: train fit
pred_gbm_train <- predict(fit_gbm, newdata=df_train_fit, type="prob")[,"present"]
Metrics::auc(df_train_fit$WnvPresent, pred_gbm_train)
caret::confusionMatrix(df_train_fit$WnvPresentF, predict(fit_gbm, newdata=df_train_fit))

# - roc / accuracy: validation
pred_logit_val <- predict(fit_gbm, newdata=df_train_val, type="prob")[,"present"]
Metrics::auc(df_train_val$WnvPresent, pred_logit_val)
caret::confusionMatrix(df_train_val$WnvPresentF, predict(fit_gbm, newdata=df_train_val))

# - fit: refit the model on all data
fit_gbm_all <- caret::train(WnvPresentF ~ Latitude + Longitude + Latitude*Longitude + Year + Month + Day + Tmax + I(Tmax^2) + PrecipTotal + I(PrecipTotal^2) + DewPoint + I(DewPoint^2) + Species + SeaLevel, data=df_train_wthr, method="gbm", verbose=F)

# - roc / accuracy: train all
pred_gbm_all <- predict(fit_gbm_all, newdata=df_train_wthr, type="prob")[,"present"]
Metrics::auc(df_train_wthr$WnvPresent, pred_gbm_all)
caret::confusionMatrix(df_train_wthr$WnvPresentF, predict(fit_gbm_all, newdata=df_train_wthr))

# - create submission file
df_submission <- load_submission(path_data_submission)
df_submission$WnvPresent <- predict(fit_gbm_all, newdata=df_test_wthr, type="prob")[,"present"]
path_submit <- file.path(dir_submissions, "gbm_regression.csv")
readr::write_csv(df_submission, path_submit)




# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# - RANDOM FORESTS (submission 5, 6)
#fit_rf <- train(WnvPresentF ~ Latitude + Longitude + Station + Block + Year + Month + Tavg + DewPoint + Species, method="rf", data=df_train_fit_regs) # submission 5
fit_rf <- train(WnvPresentF ~ Month + Tavg + DewPoint + Species, method="rf", data=df_train_fit_regs)

# - predict on both test and training
pred_test_rf <- predict(fit_rf, newdata=df_test_wthr, type="prob"); dim(pred_test_rf); dim(df_test_wthr)
pred_train_rf <- predict(fit_rf, newdata=df_train_fit_regs, type="prob"); dim(pred_train_rf); dim(df_train_fit_regs)

# - area under roc curve ... huge variance??!?
Metrics::auc(df_train_wthr$WnvPresent, pred_train_rf[,"present"])

# - accuracy
caret::confusionMatrix(df_train_wthr$WnvPresentF, predict(fit_rf, newdata=df_train_fit_regs))

# - create submission file (this should be udf)
df_submission <- load_submission(path_data_submission)
df_submission$WnvPresent <- pred_test_rf[,"present"]
dim(df_submission); head(df_submission)
path_submit <- file.path(dir_submissions, "6_initial_rf_slim.csv")
readr::write_csv(df_submission, path_submit)

```


```{r model_ensembling}
# - combine different classifiers by avg/voting



```

